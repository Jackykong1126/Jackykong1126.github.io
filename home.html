<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>活着吗</title>
  <style>
    :root { font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; }
    body { margin: 0; background: #0b0f17; color: #e7eefc; }
    .wrap { max-width: 780px; margin: 0 auto; padding: 28px 18px 40px; }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12);
            border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 10px; font-size: 22px; letter-spacing: .5px; }
    .sub { opacity: .85; margin: 0 0 18px; font-size: 14px; line-height: 1.6; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .stat { padding: 14px; border-radius: 14px; background: rgba(0,0,0,.18);
            border: 1px solid rgba(255,255,255,.10); }
    .label { font-size: 12px; opacity: .8; }
    .value { font-size: 24px; margin-top: 6px; font-weight: 700; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; align-items: center; }
    button { cursor: pointer; border: 0; border-radius: 14px; padding: 12px 14px; font-weight: 700; 
             transition: all 0.2s ease; }
    .primary { background: #7aa7ff; color: #0b0f17; }
    .ghost { background: rgba(255,255,255,.10); color: #e7eefc; border: 1px solid rgba(255,255,255,.16); }
    .danger { background: rgba(255,120,120,.14); color: #ffb6b6; border: 1px solid rgba(255,120,120,.28); }
    input[type="date"] { background: rgba(255,255,255,.08); color: #e7eefc;
      border: 1px solid rgba(255,255,255,.18); border-radius: 12px; padding: 10px 12px; }
    .muted { opacity: .8; font-size: 13px; line-height: 1.6; }
    .log { margin-top: 14px; font-size: 13px; opacity: .9; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px;
            background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.14); }
    .calendar { margin-top: 14px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .day { text-align:center; padding: 10px 0; border-radius: 12px; font-size: 12px;
           border: 1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); }
    .day.checked { background: rgba(122,167,255,.22); border-color: rgba(122,167,255,.35); }
    .day.today { outline: 2px solid rgba(255,255,255,.25); }
    
    /* 长按进度条 */
    .long-press-progress {
      position: relative;
      overflow: hidden;
    }
    .long-press-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.4));
      width: 0%;
      transition: width 0.1s linear;
      z-index: 1;
    }
    .long-press-text {
      position: relative;
      z-index: 2;
    }
    
    /* 提示框 */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.2);
      max-width: 90%;
      text-align: center;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    /* 温和提醒框 */
    .reminder {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: rgba(20, 25, 40, 0.95);
      border: 1px solid rgba(122, 167, 255, 0.3);
      border-radius: 20px;
      padding: 30px;
      z-index: 2000;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }
    .reminder.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    .reminder h2 {
      margin: 0 0 15px 0;
      color: #7aa7ff;
      text-align: center;
      font-size: 24px;
    }
    .reminder p {
      margin: 0 0 25px 0;
      line-height: 1.6;
      text-align: center;
      font-size: 16px;
    }
    .reminder-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .reminder button {
      min-width: 120px;
    }
    .reminder-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .reminder-overlay.show {
      opacity: 1;
    }
    
    /* 震动动画 */
    @keyframes vibrate {
      0% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      50% { transform: translateX(2px); }
      75% { transform: translateX(-2px); }
      100% { transform: translateX(0); }
    }
    .vibrate {
      animation: vibrate 0.1s infinite;
    }
    
    /* 心跳动画 - 用于提醒 */
    @keyframes heartbeat {
      0% { transform: scale(1); }
      25% { transform: scale(1.1); }
      50% { transform: scale(1); }
      75% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .heartbeat {
      animation: heartbeat 1.5s infinite;
      color: #ff6b6b;
      display: inline-block;
    }
    
    /* 今日状态特殊样式 - 未打卡时闪烁 */
    .status-not-checked {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    @media (max-width: 640px){ 
      .grid { grid-template-columns: 1fr; }
      .reminder { padding: 20px; }
      .reminder h2 { font-size: 20px; }
      .reminder p { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>活着吗 <span class="heartbeat" id="heartbeatIcon" style="display:none;">❤️</span></h1>
      <p class="sub">每天来这里长按打卡5秒：确认你今天还活着。数据只保存在你这台设备的浏览器里。</p>

      <div class="grid">
        <div class="stat">
          <div class="label">活了几天（从开始日到今天）</div>
          <div class="value" id="daysAlive">—</div>
        </div>
        <div class="stat">
          <div class="label">连续打卡</div>
          <div class="value" id="streak">—</div>
        </div>
        <div class="stat">
          <div class="label">总打卡天数</div>
          <div class="value" id="total">—</div>
        </div>
      </div>

      <div class="row">
        <button class="primary long-press-progress" id="checkInBtn">
          <div class="long-press-fill" id="progressFill"></div>
          <span class="long-press-text">长按5秒确认我还活着</span>
        </button>
        <span class="pill" id="todayStatus">今日状态：未打卡</span>
      </div>

      <div class="row">
        <label class="muted">开始日：</label>
        <input type="date" id="startDate" />
        <button class="ghost" id="setStartBtn">设置开始日</button>
      </div>

      <div class="row">
        <button class="ghost" id="exportBtn">导出打卡记录（JSON）</button>
        <button class="ghost" id="importBtn">导入打卡记录（JSON）</button>
        <button class="danger" id="resetBtn">清空所有数据</button>
      </div>

      <div class="log muted" id="log"></div>

      <div class="muted" style="margin-top:14px;">
        最近 28 天打卡（蓝色=已打卡）
      </div>
      <div class="calendar" id="calendar"></div>
    </div>
  </div>

  <!-- 温和提醒框 -->
  <div class="reminder-overlay" id="reminderOverlay"></div>
  <div class="reminder" id="reminder">
    <h2>今天还活着吗？</h2>
    <p>今天你还没有确认自己的存在。<br>请花5秒钟时间，长按按钮确认：<br><strong>我今天还活着</strong>。</p>
    <div class="reminder-buttons">
      <button class="primary" id="reminderCheckBtn">立即打卡</button>
      <button class="ghost" id="reminderLaterBtn">稍后提醒</button>
    </div>
  </div>

  <!-- 提示框 -->
  <div class="toast" id="toast"></div>

  <script>
    const KEY = "huozhe_ma_v1";
    const el = (id) => document.getElementById(id);
    const LONG_PRESS_TIME = 5000; // 5秒
    const REMINDER_CHECK_INTERVAL = 30 * 60 * 1000; // 30分钟检查一次
    const REMINDER_START_HOUR = 9; // 早上9点开始提醒
    const REMINDER_END_HOUR = 22; // 晚上10点停止提醒

    let reminderTimer = null;
    let lastReminderTime = 0;

    // 显示提示
    function showToast(message, duration = 2000) {
      const toast = el("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, duration);
    }

    // 显示温和提醒
    function showReminder() {
      const reminder = el("reminder");
      const overlay = el("reminderOverlay");
      const heartbeatIcon = el("heartbeatIcon");
      
      // 显示心跳图标
      heartbeatIcon.style.display = "inline-block";
      
      // 显示提醒框
      reminder.classList.add("show");
      overlay.classList.add("show");
      
      // 记录提醒时间
      lastReminderTime = Date.now();
      
      // 阻止滚动
      document.body.style.overflow = "hidden";
    }

    // 隐藏温和提醒
    function hideReminder() {
      const reminder = el("reminder");
      const overlay = el("reminderOverlay");
      const heartbeatIcon = el("heartbeatIcon");
      
      reminder.classList.remove("show");
      overlay.classList.remove("show");
      heartbeatIcon.style.display = "none";
      
      // 恢复滚动
      document.body.style.overflow = "";
    }

    // 检查是否需要提醒打卡
    function checkReminder() {
      const data = ensureData();
      const todayKey = yyyyMmDd(new Date());
      const now = new Date();
      const currentHour = now.getHours();
      
      // 如果已经打卡了，不需要提醒
      if (data.checkins[todayKey]) {
        hideReminder();
        return;
      }
      
      // 检查是否在提醒时间段内（早上9点到晚上10点）
      if (currentHour >= REMINDER_START_HOUR && currentHour < REMINDER_END_HOUR) {
        // 距离上次提醒至少30分钟
        if (Date.now() - lastReminderTime > REMINDER_CHECK_INTERVAL) {
          showReminder();
        }
      } else {
        // 不在提醒时间段，隐藏提醒
        hideReminder();
      }
    }

    // 页面加载时检查一次
    function initialReminderCheck() {
      const data = ensureData();
      const todayKey = yyyyMmDd(new Date());
      const now = new Date();
      const currentHour = now.getHours();
      
      // 如果已经打卡了，不需要提醒
      if (data.checkins[todayKey]) {
        return;
      }
      
      // 如果是第一次加载，且当前时间在提醒时间段内，显示提醒
      if (currentHour >= REMINDER_START_HOUR && currentHour < REMINDER_END_HOUR) {
        // 等待页面加载完成后再显示提醒
        setTimeout(() => {
          showReminder();
          lastReminderTime = Date.now();
        }, 1500);
      }
      
      // 设置定时检查
      if (reminderTimer) clearInterval(reminderTimer);
      reminderTimer = setInterval(checkReminder, REMINDER_CHECK_INTERVAL);
    }

    function yyyyMmDd(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function parseDateStr(s) {
      const [y, m, d] = s.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function daysBetweenInclusive(a, b) {
      const da = new Date(a.getFullYear(), a.getMonth(), a.getDate());
      const db = new Date(b.getFullYear(), b.getMonth(), b.getDate());
      const ms = db - da;
      return Math.floor(ms / 86400000) + 1;
    }

    function load() {
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }

    function save(data) {
      localStorage.setItem(KEY, JSON.stringify(data));
    }

    function defaultData() {
      const today = new Date();
      return {
        startDate: yyyyMmDd(today),
        checkins: {}
      };
    }

    function ensureData() {
      let data = load();
      if (!data || !data.startDate || !data.checkins) {
        data = defaultData();
        save(data);
      }
      return data;
    }

    function computeStats(data) {
      const today = new Date();
      const start = parseDateStr(data.startDate);
      const daysAlive = daysBetweenInclusive(start, today);

      const dates = Object.keys(data.checkins).filter(k => data.checkins[k]).sort();
      const total = dates.length;

      const todayKey = yyyyMmDd(today);
      let streak = 0;

      let cursor = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      while (true) {
        const key = yyyyMmDd(cursor);
        if (data.checkins[key]) {
          streak++;
          cursor.setDate(cursor.getDate() - 1);
        } else {
          break;
        }
      }

      return { daysAlive, total, streak, todayKey, hasToday: !!data.checkins[todayKey] };
    }

    function render() {
      const data = ensureData();
      const { daysAlive, total, streak, todayKey, hasToday } = computeStats(data);

      el("daysAlive").textContent = daysAlive;
      el("total").textContent = total;
      el("streak").textContent = streak;

      el("startDate").value = data.startDate;

      const todayStatus = el("todayStatus");
      todayStatus.textContent = `今日状态：${hasToday ? "已打卡 ✅" : "未打卡 ⏳"}`;
      
      // 未打卡时添加闪烁效果
      if (hasToday) {
        todayStatus.classList.remove("status-not-checked");
      } else {
        todayStatus.classList.add("status-not-checked");
      }
      
      const checkInBtn = el("checkInBtn");
      checkInBtn.classList.remove("vibrate");
      if (hasToday) {
        checkInBtn.innerHTML = '<span class="long-press-text">今天已打卡 ✓</span>';
        checkInBtn.disabled = true;
      } else {
        checkInBtn.innerHTML = `
          <div class="long-press-fill" id="progressFill" style="width: 0%"></div>
          <span class="long-press-text">长按5秒确认我还活着</span>
        `;
        checkInBtn.disabled = false;
      }

      const start = parseDateStr(data.startDate);
      el("log").innerHTML =
        `今天：${todayKey}｜开始日：${data.startDate}｜从开始日算起：第 <b>${daysAlive}</b> 天`;

      renderCalendar(data, 28);
    }

    function renderCalendar(data, nDays) {
      const box = el("calendar");
      box.innerHTML = "";
      const today = new Date();
      for (let i = nDays - 1; i >= 0; i--) {
        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        d.setDate(d.getDate() - i);
        const key = yyyyMmDd(d);

        const div = document.createElement("div");
        div.className = "day" + (data.checkins[key] ? " checked" : "") + (key === yyyyMmDd(today) ? " today" : "");
        div.title = key + (data.checkins[key] ? " 已打卡" : " 未打卡");
        div.textContent = key.slice(5);
        box.appendChild(div);
      }
    }

    // 长按打卡逻辑
    let pressTimer = null;
    let pressStartTime = 0;
    let progressInterval = null;

    function startLongPress(event) {
      const btn = el("checkInBtn");
      const data = ensureData();
      const todayKey = yyyyMmDd(new Date());
      
      if (data.checkins[todayKey]) {
        return;
      }

      event.preventDefault();
      
      pressStartTime = Date.now();
      btn.classList.add("vibrate");
      
      showToast("保持按住... 5秒后完成打卡", LONG_PRESS_TIME);
      
      const progressFill = el("progressFill");
      let progress = 0;
      
      progressInterval = setInterval(() => {
        const elapsed = Date.now() - pressStartTime;
        progress = Math.min((elapsed / LONG_PRESS_TIME) * 100, 100);
        if (progressFill) {
          progressFill.style.width = progress + "%";
        }
        
        const remaining = Math.max(0, (LONG_PRESS_TIME - elapsed) / 1000);
        if (remaining > 0) {
          const textSpan = btn.querySelector('.long-press-text');
          if (textSpan) {
            textSpan.textContent = `保持按住... ${remaining.toFixed(1)}秒`;
          }
        }
      }, 50);
      
      pressTimer = setTimeout(() => {
        completeCheckIn();
        if (progressInterval) clearInterval(progressInterval);
        btn.classList.remove("vibrate");
        hideReminder(); // 打卡成功后隐藏提醒
        showToast("✅ 打卡成功！今天确认活着", 3000);
      }, LONG_PRESS_TIME);
    }

    function cancelLongPress() {
      if (pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
      }
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      
      const btn = el("checkInBtn");
      btn.classList.remove("vibrate");
      
      const progressFill = el("progressFill");
      if (progressFill) {
        progressFill.style.width = "0%";
      }
      
      const textSpan = btn.querySelector('.long-press-text');
      if (textSpan && !btn.disabled) {
        textSpan.textContent = "长按5秒确认我还活着";
      }
    }

    function completeCheckIn() {
      const data = ensureData();
      const key = yyyyMmDd(new Date());
      data.checkins[key] = true;
      save(data);
      render();
    }

    // 事件监听
    const checkInBtn = el("checkInBtn");
    
    // 鼠标事件（桌面）
    checkInBtn.addEventListener("mousedown", startLongPress);
    checkInBtn.addEventListener("mouseup", cancelLongPress);
    checkInBtn.addEventListener("mouseleave", cancelLongPress);
    
    // 触摸事件（移动端）
    checkInBtn.addEventListener("touchstart", (e) => {
      startLongPress(e);
      e.preventDefault();
    });
    checkInBtn.addEventListener("touchend", cancelLongPress);
    checkInBtn.addEventListener("touchcancel", cancelLongPress);

    // 防止右键菜单
    checkInBtn.addEventListener("contextmenu", (e) => {
      e.preventDefault();
    });

    // 提醒框按钮事件
    el("reminderCheckBtn").addEventListener("click", () => {
      hideReminder();
      // 自动开始长按打卡
      startLongPress({ preventDefault: () => {} });
    });

    el("reminderLaterBtn").addEventListener("click", () => {
      hideReminder();
      showToast("好的，稍后记得打卡哦", 2000);
      // 设置30分钟后再提醒
      setTimeout(() => {
        checkReminder();
      }, REMINDER_CHECK_INTERVAL);
    });

    // 点击遮罩层关闭提醒
    el("reminderOverlay").addEventListener("click", () => {
      hideReminder();
      showToast("记得今天打卡确认活着哦", 2000);
    });

    // 其他事件
    el("setStartBtn").addEventListener("click", () => {
      const data = ensureData();
      const v = el("startDate").value;
      if (!v) return;
      data.startDate = v;
      save(data);
      render();
    });

    el("resetBtn").addEventListener("click", () => {
      const ok = confirm("确定清空所有数据吗？这会删除开始日与全部打卡记录。");
      if (!ok) return;
      localStorage.removeItem(KEY);
      render();
    });

    el("exportBtn").addEventListener("click", async () => {
      const data = ensureData();
      const text = JSON.stringify(data, null, 2);
      try {
        await navigator.clipboard.writeText(text);
        showToast("已复制到剪贴板（JSON）", 2000);
      } catch {
        const blob = new Blob([text], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "活着吗-打卡记录.json";
        a.click();
        URL.revokeObjectURL(a.href);
      }
    });

    el("importBtn").addEventListener("click", () => {
      const text = prompt("把导出的 JSON 粘贴到这里：");
      if (!text) return;
      try {
        const obj = JSON.parse(text);
        if (!obj.startDate || typeof obj.checkins !== "object") throw new Error("格式不对");
        save(obj);
        render();
        showToast("导入成功！", 2000);
      } catch (e) {
        showToast("导入失败：JSON格式不正确", 2000);
      }
    });

    // 初始化
    render();
    initialReminderCheck();
    
    // 页面可见性变化时检查（用户切换回标签页时）
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) {
        render();
        checkReminder();
      }
    });
    
    // 每小时检查一次是否在提醒时间段
    setInterval(checkReminder, 60 * 60 * 1000);
  </script>
</body>
</html>

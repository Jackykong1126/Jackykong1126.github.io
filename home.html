<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>活着吗</title>
  <style>
    :root { font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; }
    body { margin: 0; background: #0b0f17; color: #e7eefc; }
    .wrap { max-width: 780px; margin: 0 auto; padding: 28px 18px 40px; }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12);
            border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 10px; font-size: 22px; letter-spacing: .5px; }
    .sub { opacity: .85; margin: 0 0 18px; font-size: 14px; line-height: 1.6; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .stat { padding: 14px; border-radius: 14px; background: rgba(0,0,0,.18);
            border: 1px solid rgba(255,255,255,.10); }
    .label { font-size: 12px; opacity: .8; }
    .value { font-size: 24px; margin-top: 6px; font-weight: 700; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; align-items: center; }
    button { cursor: pointer; border: 0; border-radius: 14px; padding: 12px 14px; font-weight: 700; }
    .primary { background: #7aa7ff; color: #0b0f17; }
    .ghost { background: rgba(255,255,255,.10); color: #e7eefc; border: 1px solid rgba(255,255,255,.16); }
    .danger { background: rgba(255,120,120,.14); color: #ffb6b6; border: 1px solid rgba(255,120,120,.28); }
    input[type="date"] { background: rgba(255,255,255,.08); color: #e7eefc;
      border: 1px solid rgba(255,255,255,.18); border-radius: 12px; padding: 10px 12px; }
    .muted { opacity: .8; font-size: 13px; line-height: 1.6; }
    .log { margin-top: 14px; font-size: 13px; opacity: .9; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px;
            background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.14); }
    .calendar { margin-top: 14px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .day { text-align:center; padding: 10px 0; border-radius: 12px; font-size: 12px;
           border: 1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); }
    .day.checked { background: rgba(122,167,255,.22); border-color: rgba(122,167,255,.35); }
    .day.today { outline: 2px solid rgba(255,255,255,.25); }
    @media (max-width: 640px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>活着吗</h1>
      <p class="sub">每天来这里点一下：算你今天也活着。数据只保存在你这台设备的浏览器里。</p>

      <div class="grid">
        <div class="stat">
          <div class="label">活了几天（从开始日到今天）</div>
          <div class="value" id="daysAlive">—</div>
        </div>
        <div class="stat">
          <div class="label">连续打卡</div>
          <div class="value" id="streak">—</div>
        </div>
        <div class="stat">
          <div class="label">总打卡天数</div>
          <div class="value" id="total">—</div>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="checkInBtn">今天我还活着（打卡）</button>
        <span class="pill" id="todayStatus">今日状态：未打卡</span>
      </div>

      <div class="row">
        <label class="muted">开始日：</label>
        <input type="date" id="startDate" />
        <button class="ghost" id="setStartBtn">设置开始日</button>
      </div>

      <div class="row">
        <button class="ghost" id="exportBtn">导出打卡记录（JSON）</button>
        <button class="ghost" id="importBtn">导入打卡记录（JSON）</button>
        <button class="danger" id="resetBtn">清空所有数据</button>
      </div>

      <div class="log muted" id="log"></div>

      <div class="muted" style="margin-top:14px;">
        最近 28 天打卡（蓝色=已打卡）
      </div>
      <div class="calendar" id="calendar"></div>
    </div>
  </div>

  <script>
    const KEY = "huozhe_ma_v1";
    const el = (id) => document.getElementById(id);

    function yyyyMmDd(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function parseDateStr(s) {
      // treat as local date
      const [y, m, d] = s.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function daysBetweenInclusive(a, b) {
      // local-midnight normalize
      const da = new Date(a.getFullYear(), a.getMonth(), a.getDate());
      const db = new Date(b.getFullYear(), b.getMonth(), b.getDate());
      const ms = db - da;
      return Math.floor(ms / 86400000) + 1; // inclusive
    }

    function load() {
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }

    function save(data) {
      localStorage.setItem(KEY, JSON.stringify(data));
    }

    function defaultData() {
      const today = new Date();
      // 默认开始日：今天（你也可以改成生日）
      return {
        startDate: yyyyMmDd(today),
        checkins: {} // { "YYYY-MM-DD": true }
      };
    }

    function ensureData() {
      let data = load();
      if (!data || !data.startDate || !data.checkins) {
        data = defaultData();
        save(data);
      }
      return data;
    }

    function computeStats(data) {
      const today = new Date();
      const start = parseDateStr(data.startDate);
      const daysAlive = daysBetweenInclusive(start, today);

      const dates = Object.keys(data.checkins).filter(k => data.checkins[k]).sort();
      const total = dates.length;

      const todayKey = yyyyMmDd(today);
      let streak = 0;

      // streak: 从今天开始向前连续打卡
      let cursor = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      while (true) {
        const key = yyyyMmDd(cursor);
        if (data.checkins[key]) {
          streak++;
          cursor.setDate(cursor.getDate() - 1);
        } else {
          break;
        }
      }

      return { daysAlive, total, streak, todayKey, hasToday: !!data.checkins[todayKey] };
    }

    function render() {
      const data = ensureData();
      const { daysAlive, total, streak, todayKey, hasToday } = computeStats(data);

      el("daysAlive").textContent = daysAlive;
      el("total").textContent = total;
      el("streak").textContent = streak;

      el("startDate").value = data.startDate;

      el("todayStatus").textContent = `今日状态：${hasToday ? "已打卡 ✅" : "未打卡 ⏳"}`;
      el("checkInBtn").disabled = hasToday;
      el("checkInBtn").textContent = hasToday ? "今天已打卡" : "今天我还活着（打卡）";

      const start = parseDateStr(data.startDate);
      el("log").innerHTML =
        `今天：${todayKey}｜开始日：${data.startDate}｜从开始日算起：第 <b>${daysAlive}</b> 天`;

      renderCalendar(data, 28);
    }

    function renderCalendar(data, nDays) {
      const box = el("calendar");
      box.innerHTML = "";
      const today = new Date();
      for (let i = nDays - 1; i >= 0; i--) {
        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        d.setDate(d.getDate() - i);
        const key = yyyyMmDd(d);

        const div = document.createElement("div");
        div.className = "day" + (data.checkins[key] ? " checked" : "") + (key === yyyyMmDd(today) ? " today" : "");
        div.title = key + (data.checkins[key] ? " 已打卡" : " 未打卡");
        div.textContent = key.slice(5); // MM-DD
        box.appendChild(div);
      }
    }

    // events
    el("checkInBtn").addEventListener("click", () => {
      const data = ensureData();
      const key = yyyyMmDd(new Date());
      data.checkins[key] = true;
      save(data);
      render();
    });

    el("setStartBtn").addEventListener("click", () => {
      const data = ensureData();
      const v = el("startDate").value;
      if (!v) return;
      data.startDate = v;
      save(data);
      render();
    });

    el("resetBtn").addEventListener("click", () => {
      const ok = confirm("确定清空所有数据吗？这会删除开始日与全部打卡记录。");
      if (!ok) return;
      localStorage.removeItem(KEY);
      render();
    });

    el("exportBtn").addEventListener("click", async () => {
      const data = ensureData();
      const text = JSON.stringify(data, null, 2);
      try {
        await navigator.clipboard.writeText(text);
        alert("已复制到剪贴板（JSON）");
      } catch {
        // fallback: download
        const blob = new Blob([text], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "活着吗-打卡记录.json";
        a.click();
        URL.revokeObjectURL(a.href);
      }
    });

    el("importBtn").addEventListener("click", () => {
      const text = prompt("把导出的 JSON 粘贴到这里：");
      if (!text) return;
      try {
        const obj = JSON.parse(text);
        if (!obj.startDate || typeof obj.checkins !== "object") throw new Error("格式不对");
        save(obj);
        render();
        alert("导入成功！");
      } catch (e) {
        alert("导入失败：JSON 格式不正确或缺少字段");
      }
    });

    // init
    render();
  </script>
</body>
</html>
